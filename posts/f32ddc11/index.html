<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.ico?v=2.0.0-rc.0" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.ico?v=2.0.0-rc.0" type="image/png" sizes="32x32"><meta name="description" content="tcpdump使用教程       一般情况下，非HTTP协议的网络分析，在服务器端用tcpdump比较多，在客户端用wireshark比较多，两个抓包软件的语法是一样的。                    一、基本语法       1.1、过滤主机抓取所有经过eth1，目的或源地址是192.168.1.1的网络数据tcpdump -i eth1 host 192.168"><meta property="og:type" content="article"><meta property="og:title" content="tcpdump使用教程"><meta property="og:url" content="https://www.gov-cn.cn/posts/f32ddc11/index.html"><meta property="og:site_name" content="hihi007&#39;s Blog"><meta property="og:description" content="tcpdump使用教程       一般情况下，非HTTP协议的网络分析，在服务器端用tcpdump比较多，在客户端用wireshark比较多，两个抓包软件的语法是一样的。                    一、基本语法       1.1、过滤主机抓取所有经过eth1，目的或源地址是192.168.1.1的网络数据tcpdump -i eth1 host 192.168"><meta property="article:published_time" content="2017-09-02T02:28:51.000Z"><meta property="article:modified_time" content="2020-04-06T15:26:41.811Z"><meta property="article:author" content="hihi007"><meta property="article:tag" content="网络工具"><meta name="twitter:card" content="summary"><meta name="keywords" content="hihi007, hihi007's Blog"><meta name="description" content="hihi007的个人博客"><title>tcpdump使用教程</title><link ref="canonical" href="https://www.gov-cn.cn/posts/f32ddc11/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.0.0-rc.0"><script>var Stun=window.Stun||{},CONFIG={root:"/",algolia:void 0,fontIcon:{prompt:{success:"fas fa-check-circle",info:"fas fa-arrow-circle-right",warning:"fas fa-exclamation-circle",error:"fas fa-times-circle"},copyBtn:"fas fa-copy"},sidebar:{offsetTop:"20px",tocMaxDepth:6},header:{enable:!0,showOnPost:!0,scrollDownIcon:!0},postWidget:{endText:!0},nightMode:{enable:!0},back2top:{enable:!0},codeblock:{style:"carbon",highlight:"ocean",wordWrap:!0},reward:!0,fancybox:!0,zoomImage:{gapAside:"20px"},galleryWaterfall:void 0,lazyload:!1,pjax:{avoidBanner:!1},externalLink:{icon:{enable:!0,name:"fas fa-external-link-alt"}},shortcuts:void 0,prompt:{copyButton:"Copy",copySuccess:"Copy Success",copyError:"Copy Error"},sourcePath:{js:"js",css:"css",images:"images"}};window.CONFIG=CONFIG</script><meta name="generator" content="Hexo 4.2.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">Home</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="javascript:;" onclick="return!1"><span class="header-nav-menu-item__icon"><i class="fas fa-list"></i></span><span class="header-nav-menu-item__text">文章</span></a><div class="header-nav-submenu"><div class="header-nav-submenu-item"><a class="header-nav-submenu-item__link" href="/archives/"><span class="header-nav-submenu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-submenu-item__text">Archives</span></a></div><div class="header-nav-submenu-item"><a class="header-nav-submenu-item__link" href="/categories/"><span class="header-nav-submenu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-submenu-item__text">Categories</span></a></div><div class="header-nav-submenu-item"><a class="header-nav-submenu-item__link" href="/tags/"><span class="header-nav-submenu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-submenu-item__text">Tags</span></a></div></div></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="javascript:;" onclick="return!1"><span class="header-nav-menu-item__icon"><i class="fas fa-flask"></i></span><span class="header-nav-menu-item__text">实验室</span></a><div class="header-nav-submenu"><div class="header-nav-submenu-item"><a class="header-nav-submenu-item__link" href="/labs/myst/"><span class="header-nav-submenu-item__icon"><i class="fas fa-user-secret"></i></span><span class="header-nav-submenu-item__text">秘境</span></a></div></div></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/about/"><span class="header-nav-menu-item__icon"><i class="fas fa-user"></i></span><span class="header-nav-menu-item__text">About</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/links/"><span class="header-nav-menu-item__icon"><i class="fas fa-link"></i></span><span class="header-nav-menu-item__text">友链</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">Search</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">hihi007's Blog</div><div class="header-banner-info__subtitle">唯一不变的就是一直在变</div></div><div class="header-banner-arrow"><div class="header-banner-arrow__icon"><i class="fas fa-angle-down"></i></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">tcpdump使用教程</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2017-09-02</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2020-04-06</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">Words</span><span class="post-meta-item__value">2.2k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">Reading</span><span class="post-meta-item__value">18m</span></span><span class="post-meta-item post-meta-item--visitors"><span class="post-meta-item__icon" data-popover="Visitors" data-popover-pos="up"><i class="fas fa-eye"></i></span><span class="post-meta-item__value" id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body"><h4 id="tcpdump使用教程"><a href="#tcpdump使用教程" class="heading-link"><i class="fas fa-link"></i></a>tcpdump使用教程</h4><blockquote><p><strong>一般情况下，非HTTP协议的网络分析，在服务器端用tcpdump比较多，在客户端用wireshark比较多，两个抓包软件的语法是一样的。</strong></p></blockquote><h3 id="一、基本语法"><a href="#一、基本语法" class="heading-link"><i class="fas fa-link"></i></a>一、基本语法</h3><p><strong>1.1、过滤主机</strong><br>抓取所有经过eth1，目的或源地址是192.168.1.1的网络数据<br><code>tcpdump -i eth1 host 192.168.1.1</code><br>指定源地址<br><code>tcpdump -i eth1 src host 192.168.1.1</code><br>指定目的地址<br><code>tcpdump -i eth1 dst host 192.168.1.1</code></p><a id="more"></a><p><strong>1.2、过滤端口</strong><br>抓取所有经过eth1，目的或源端口是25的网络数据<br><code>tcpdump -i eth1 port 25</code><br>指定源端口<br><code>tcpdump -i eth1 src port 25</code><br>指定目的端口<br><code>tcpdump -i eth1 dst port 25</code><br><strong>1.3、网络过滤</strong><br><code>tcpdump -i eth1 net 192.168 tcpdump -i eth1 src net 192.168 tcpdump -i eth1 dst net 192.168</code><br><strong>1.4、协议过滤</strong><br><code>tcpdump -i eth1 arp</code><br><code>tcpdump -i eth1 ip</code><br><code>tcpdump -i eth1 tcp</code><br><code>tcpdump -i eth1 udp</code><br><code>tcpdump -i eth1 icmp</code><br><strong>1.5、常用表达式</strong><br><code>非 : ! or "not" (去掉双引号) 且 : &amp;&amp; or "and" 或 : || or "or"</code><br>抓取所有经过eth1，目的地址是192.168.1.254或192.168.1.200端口是80的TCP数据<br><code>tcpdump -i eth1 '((tcp) and (port 80) and ((dst host 192.168.1.254) or (dst host 192.168.1.200)))'</code><br>抓取所有经过eth1，目标MAC地址是00:01:02:03:04:05的ICMP数据<br><code>tcpdump -i eth1 '((icmp) and ((ether dst host 00:01:02:03:04:05)))'</code><br>抓取所有经过eth1，目的网络是192.168，但目的主机不是192.168.1.200的TCP数据<br><code>tcpdump -i eth1 '((tcp) and ((dst net 192.168) and (not dst host 192.168.1.200)))'</code><br>二、高级包头过滤<br>首先了解如何从包头过滤信息<br><code>proto[x:y] : 过滤从x字节开始的y字节数。比如ip[2:2]过滤出3、4字节（第一字节从0开始排）</code><br><code>proto[x:y] &amp; z = 0 : proto[x:y]和z的与操作为0</code><br><code>proto[x:y] &amp; z !=0 : proto[x:y]和z的与操作不为0</code><br><code>proto[x:y] &amp; z = z : proto[x:y]和z的与操作为z</code><br><code>proto[x:y] = z : proto[x:y]等于z</code><br>操作符 : &gt;, &lt;, &gt;=, &lt;=, =, !=</p><p><strong>2.1、IP头</strong></p><figure class="highlight bash"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">0                   1                   2                   3</span><br><span class="line"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line"> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line"> |Version|  IHL  |Type of Service|          Total Length         |</span><br><span class="line"> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line"> |         Identification        |Flags|      Fragment Offset    |</span><br><span class="line"> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line"> |  Time to Live |    Protocol   |         Header Checksum       |</span><br><span class="line"> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line"> |                       Source Address                          |</span><br><span class="line"> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line"> |                    Destination Address                        |</span><br><span class="line"> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line"> |                    Options                    |    Padding    | &lt;-- optional</span><br><span class="line"> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line"> |                            DATA ...                           |</span><br><span class="line"> +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></tbody></table></div></figure><p>本文只针对IPv4。</p><p>2.2、IP选项设置了吗？<br>“一般”的IP头是20字节，但IP头有选项设置，不能直接从偏移21字节处读取数据。IP头有个长度字段可以知道头长度是否大于20字节。</p><figure class="highlight plain"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+-+-+-+-+-+-+-+-+</span><br><span class="line">|Version|  IHL  |</span><br><span class="line">+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></tbody></table></div></figure><p>通常第一个字节的二进制值是：01000101，分成两个部分：</p><p>0100 = 4 表示IP版本 0101 = 5 表示IP头32 bit的块数，5 x 32 bits = 160 bits or 20 bytes</p><p>如果第一字节第二部分的值大于5，那么表示头有IP选项。</p><p>下面介绍两种过滤方法（第一种方法比较操蛋，可忽略）：</p><p>a. 比较第一字节的值是否大于01000101，这可以判断IPv4带IP选项的数据和IPv6的数据。</p><p>01000101十进制等于69，计算方法如下（小提示：用计算器更方便）</p><figure class="highlight plain"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0 : 0  \</span><br><span class="line">1 : 2^6 = 64 \ 第一部分 (IP版本)</span><br><span class="line">0 : 0   /</span><br><span class="line">0 : 0  /</span><br><span class="line">-</span><br><span class="line">0 : 0  \</span><br><span class="line">1 : 2^2 = 4  \ 第二部分 (头长度)</span><br><span class="line">0 : 0   /</span><br><span class="line">1 : 2^0 = 1 /</span><br><span class="line">64 + 4 + 1 = 69</span><br></pre></td></tr></tbody></table></div></figure><p>如果设置了IP选项，那么第一自己是01000110（十进制70），过滤规则：</p><p><code>tcpdump -i eth1 'ip[0] &gt; 69'</code><br>IPv6的数据也会匹配，看看第二种方法。</p><p>b. 位操作</p><p>0100 0101 : 第一字节的二进制<br>0000 1111 : 与操作<br>&lt;=========<br>0000 0101 : 结果</p><p>正确的过滤方法<br><code>tcpdump -i eth1 'ip[0] &amp; 15 &gt; 5'</code><br>或者<br><code>tcpdump -i eth1 'ip[0] &amp; 0x0f &gt; 5'</code><br><strong>2.3、分片标记</strong><br>当发送端的MTU大于到目的路径链路上的MTU时就会被分片，这段话有点拗口，权威的请参考《TCP/IP详解》。唉，32借我的书没还，只能凑合写，大家记得看书啊。</p><p>分片信息在IP头的第七和第八字节：</p><figure class="highlight plain"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|Flags|      Fragment Offset    |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></tbody></table></div></figure><p>Bit 0: 保留，必须是0<br>Bit 1: (DF) 0 = 可能分片, 1 = 不分片<br>Bit 2: (MF) 0 = 最后的分片, 1 = 还有分片</p><p>Fragment Offset字段只有在分片的时候才使用。</p><p>要抓带DF位标记的不分片的包，第七字节的值应该是：</p><p>01000000 = 64</p><p><code>tcpdump -i eth1 'ip[6] = 64'</code><br><strong>2.4、抓分片包</strong><br>匹配MF，分片包<br><code>tcpdump -i eth1 'ip[6] = 32'</code><br>最后分片包的开始3位是0，但是有Fragment Offset字段。</p><p>匹配分片和最后分片<br><code>tcpdump -i eth1 '((ip[6:2] &gt; 0) and (not ip[6] = 64))'</code><br>测试分片可以用下面的命令：</p><p><code>ping -M want -s 3000 192.168.1.1</code><br><strong>2.5、匹配小TTL</strong><br>TTL字段在第九字节，并且正好是完整的一个字节，TTL最大值是255，二进制为11111111。</p><p>可以用下面的命令验证一下：</p><figure class="highlight plain"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ping -M want -s 3000 -t 256 192.168.1.200</span><br><span class="line">ping: ttl 256 out of range</span><br><span class="line"> +-+-+-+-+-+-+-+-+</span><br><span class="line"> |  Time to Live |</span><br><span class="line"> +-+-+-+-+-+-+-+-+</span><br></pre></td></tr></tbody></table></div></figure><p>在网关可以用下面的命令看看网络中谁在使用traceroute<br>tcpdump -i eth1 ‘ip[8] &lt; 5’<br><strong>2.6、抓大于X字节的包</strong><br>大于600字节<br><code>tcpdump -i eth1 'ip[2:2] &gt; 600'</code><br><strong>2.7、更多的IP过滤</strong><br>首先还是需要知道TCP基本结构，再次推荐《TCP/IP详解》，卷一就够看的了，避免走火入魔。</p><p>TCP头</p><figure class="highlight plain"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">0                   1                   2                   3</span><br><span class="line">0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|          Source Port          |       Destination Port        |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                        Sequence Number                        |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                    Acknowledgment Number                      |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|  Data |       |C|E|U|A|P|R|S|F|                               |</span><br><span class="line">| Offset|  Res. |W|C|R|C|S|S|Y|I|            Window             |</span><br><span class="line">|       |       |R|E|G|K|H|T|N|N|                               |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|           Checksum            |         Urgent Pointer        |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                    Options                    |    Padding    |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                             data                              |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></tbody></table></div></figure><p>抓取源端口大于1024的TCP数据包<br>tcpdump -i eth1 ‘tcp[0:2] &gt; 1024’<br>匹配TCP数据包的特殊标记<br>TCP标记定义在TCP头的第十四个字节</p><figure class="highlight plain"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+-+-+-+-+-+-+-+-+</span><br><span class="line">|C|E|U|A|P|R|S|F|</span><br><span class="line">|W|C|R|C|S|S|Y|I|</span><br><span class="line">|R|E|G|K|H|T|N|N|</span><br><span class="line">+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></tbody></table></div></figure><p>重复一下TCP三次握手，两个主机是如何勾搭的：</p><p>源发送SYN<br>目标回答SYN, ACK<br>源发送ACK<br>没女朋友的童鞋要学习一下：</p><ol><li>MM，你的手有空吗？–</li><li>有空，你呢？~~</li><li>我也有空 <em>_</em></li></ol><p>失败的loser是酱紫的：</p><ol><li>MM，这是你掉的板砖吗？(SYN) ￣▽￣</li><li>不是，找拍啊？(RST-ACK) ˋ﹏ˊ</li></ol><p>只抓SYN包，第十四字节是二进制的00000010，也就是十进制的2<br><code>tcpdump -i eth1 'tcp[13] = 2'</code><br>抓SYN, ACK （00010010 or 18）<br><code>tcpdump -i eth1 'tcp[13] = 18'</code><br>抓SYN或者SYN-ACK<br><code>tcpdump -i eth1 'tcp[13] &amp; 2 = 2'</code><br>用到了位操作，就是不管ACK位是啥。</p><p>抓PSH-ACK<br><code>tcpdump -i eth1 'tcp[13] = 24'</code><br>抓所有包含FIN标记的包（FIN通常和ACK一起，表示幽会完了，回见）<br><code>tcpdump -i eth1 'tcp[13] &amp; 1 = 1'</code><br>抓RST（勾搭没成功，伟大的greatwall对她认为有敏感信息的连接发RST包，典型的棒打鸳鸯）<br><code>tcpdump -i eth1 'tcp[13] &amp; 4 = 4'</code></p><p><strong>2.8、大叔注</strong><br>tcpdump考虑了一些数字恐惧症者的需求，提供了部分常用的字段偏移名字：</p><p>icmptype (ICMP类型字段)<br>icmpcode (ICMP符号字段)<br>tcpflags (TCP标记字段)</p><p>ICMP类型值有：</p><p>icmp-echoreply, icmp-unreach, icmp-sourcequench, icmp-redirect, icmp-echo, icmp-routeradvert, icmp-routersolicit, icmp-timxceed, icmp-paramprob, icmp-tstamp, icmp-tstampreply, icmp-ireq, icmp-ireqreply, icmp-maskreq, icmp-maskreply</p><p>TCP标记值：</p><p>tcp-fin, tcp-syn, tcp-rst, tcp-push, tcp-push, tcp-ack, tcp-urg</p><p>这样上面按照TCP标记位抓包的就可以写直观的表达式了：</p><p>只抓SYN包<br><code>tcpdump -i eth1 'tcp[tcpflags] = tcp-syn'</code><br>抓SYN, ACK<br><code>tcpdump -i eth1 'tcp[tcpflags] &amp; tcp-syn != 0 and tcp[tcpflags] &amp; tcp-ack != 0'</code><br><strong>2.9、抓SMTP数据</strong><br><code>tcpdump -i eth1 '((port 25) and (tcp[(tcp[12]&gt;&gt;2):4] = 0x4d41494c))'</code><br>抓取数据区开始为”MAIL”的包，”MAIL”的十六进制为0x4d41494c。</p><p><strong>2.10、抓HTTP GET数据</strong><br><code>tcpdump -i eth1 'tcp[(tcp[12]&gt;&gt;2):4] = 0x47455420'</code><br>“GET “的十六进制是47455420</p><p><strong>2.11、抓SSH返回</strong><br><code>tcpdump -i eth1 'tcp[(tcp[12]&gt;&gt;2):4] = 0x5353482D'</code><br>“SSH-“的十六进制是0x5353482D</p><p><code>tcpdump -i eth1 '(tcp[(tcp[12]&gt;&gt;2):4] = 0x5353482D) and (tcp[((tcp[12]&gt;&gt;2)+4):2] = 0x312E)'</code><br>抓老版本的SSH返回信息，如”SSH-1.99..”</p><p><strong>三、大叔注</strong><br>如果是为了查看数据内容，建议用tcpdump -s 0 -w filename把数据包都保存下来，然后用wireshark的Follow TCP Stream/Follow UDP Stream来查看整个会话的内容。</p><p>-s 0是抓取完整数据包，否则默认只抓68字节。</p><p>另外，用tcpflow也可以方便的获取TCP会话内容，支持tcpdump的各种表达式。</p><p><strong>3.1、UDP头</strong></p><figure class="highlight plain"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> 0      7 8     15 16    23 24    31</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|     Source      |   Destination   |</span><br><span class="line">|      Port       |      Port       |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|                 |                 |</span><br><span class="line">|     Length      |    Checksum     |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|                                   |</span><br><span class="line">|              DATA ...             |</span><br><span class="line">+-----------------------------------+</span><br></pre></td></tr></tbody></table></div></figure><p>抓DNS请求数据<br><code>tcpdump -i eth1 udp dst port 53</code><br><strong>3.2、其他</strong><br>-c参数对于运维人员来说也比较常用，因为流量比较大的服务器，靠人工CTRL+C还是抓的太多，甚至导致服务器宕机，于是可以用-c参数指定抓多少个包。</p><p><code>time tcpdump -nn -i eth0 'tcp[tcpflags] = tcp-syn' -c 10000 &gt; /dev/null</code><br>上面的命令计算抓10000个SYN包花费多少时间，可以判断访问量大概是多少。</p><script>document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });</script></div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ END ------</div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="https://www.gov-cn.cn/tags/%E7%BD%91%E7%BB%9C%E5%B7%A5%E5%85%B7/">网络工具</a></span></div><div class="post-reward reward"><div class="reward-button">Buy me a coffee</div><div class="reward-qrcode"><span class="reward-qrcode-alipay"><img class="reward-qrcode-alipay__img" src="https://static-hk.gov-cn.cn/cdn/images/alipay.jpg"><div class="reward-qrcode-alipay__text">Alipay</div></span><span class="reward-qrcode-wechat"><img class="reward-qrcode-wechat__img" src="https://static-hk.gov-cn.cn/cdn/images/wechatpay.jpg"><div class="reward-qrcode-wechat__text">Wechat</div></span></div></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/posts/84de9b61/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">Linux上创建交换分区</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/posts/6c6819bc/"><span class="paginator-prev__text">SQL注入之基础原理</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div><div class="comments" id="comments"><div id="valine-container"></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">Catalog</span><span class="sidebar-nav-ov">Overview</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#tcpdump使用教程"><span class="toc-number">1.</span> <span class="toc-text">tcpdump使用教程</span></a></li></ol><li class="toc-item toc-level-3"><a class="toc-link" href="#一、基本语法"><span class="toc-number"></span> <span class="toc-text">一、基本语法</span></a></li></section><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/icons/avatar.svg" alt="avatar"></div><p class="sidebar-ov-author__text">唯一不变的就是一直在变</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/beytagh-stark" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a><a class="sidebar-ov-social-item" href="https://static-hk.gov-cn.cn/cdn/images/wechatqr.png" target="_blank" rel="noopener" data-popover="Wechat" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-weixin"></i></span></a><a class="sidebar-ov-social-item" href="https://t.me/hihi007s" target="_blank" rel="noopener" data-popover="Telegram" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-telegram"></i></span></a><a class="sidebar-ov-social-item" href="http://wpa.qq.com/msgrd?v=3&amp;uin=1727488558&amp;site=qq&amp;menu=yes" target="_blank" rel="noopener" data-popover="QQ" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-qq"></i></span></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">You have read </span><span class="sidebar-reading-info__num">0</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2016~2020</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>gov-cn.cn</span><span class="footer__devider">|</span><span>粤ICP备-19148026号</span></div><div class="busuanzi"><span class="busuanzi-siteuv"><span class="busuanzi-siteuv__icon" data-popover-pos="up" data-popover="Unique Visitor"><i class="fas fa-user"></i></span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_uv"></span></span><span class="busuanzi-sitepv"><span class="busuanzi-siteuv__icon" data-popover-pos="up" data-popover="Page View"><i class="fas fa-eye"></i></span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_pv"></span></span></div><div>技术支持：Service:Github Pages / Admin:Hexo / Theme:Stun</div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="Search for Posts (Support multiple keywords)"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/ribbon.js@latest/dist/ribbon.min.js" size="120" alpha="0.6" zindex="-1"></script><script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script>function initSearch(){var i=!0,e="search.json";e?/json$/i.test(e)&&(i=!1):e="search.xml";var t="/"+e;$.ajax({url:t,dataType:i?"xml":"json",async:!0,success:function(e){var n=i?$("entry",e).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():e,o=$(".search-input input"),c=$(".search-results"),y=100,m=1,t=function(){var e=o.val().toLowerCase().trim(),x=e.split(/[\s]+/),w=[];1<x.length&&x.push(e),0<e.length&&n.forEach(function(e){var t=!1,n=e.title&&e.title.trim()||"[ Untitled ]",o=n&&n.toLowerCase(),c=e.content&&e.content.replace(/<[^>]+>/g,""),i=c&&c.toLowerCase(),r=e.url&&decodeURI(e.url).replace(/\/{2,}/g,"/"),s=[],a=[];x.forEach(function(e){function t(t,e,n,o){if(!t||!e)return[];var c=0,i=-1,r=[];for(n||(t=t.toLowerCase(),e=e.toLowerCase());-1!==(i=e.indexOf(t,c));){var a=!1;s.forEach(function(e){e.index===i&&e.word.length<t.length&&(e.word=t,a=!0)}),c=i+t.length,!a&&r.push({index:i,word:t,weight:o})}return r}s=s.concat(t(e,o,!1,y)),a=a.concat(t(e,i,!1,m))});var l=s.length,u=a.length;if((0<l||0<u)&&(t=!0),t){function h(n,e,t,o){if(n&&e&&e.length){var c="",i=t,r=o;return e.forEach(function(e){if(!(e.index<i)){var t=e.index+e.word.length;c+=n.slice(i,e.index),c+="<b>"+n.slice(e.index,t)+"</b>",i=t}}),c+=n.slice(i,r)}}[s,a].forEach(function(e){e.sort(function(e,t){return e.index-t.index})});var d,f={},p=s.length*y+a.length*m,v=h(n,s,0,n.length)||n;if(0<a.length){var g=a[0].index;d=h(c,a,20<g?g-20:0,g+180)}else d=c.slice(0,200);f.title=v,f.content=d,f.url=r,f.weight=p,w.push(f)}});var t="";w.length?(w.sort(function(e,t){return t.weight-e.weight}),t+="<ul>",w.forEach(function(e){t+='<li><a class="search-results-title" href="'+e.url+'">',t+=e.title,t+='</a><div class="search-results-content">',t+=e.content,t+="</div></li>"}),t+="</ul>"):t+='<div class="search-results-none"><i class="far fa-meh"></i></div>',c.html(t)};o.on("input",t),o.on("keyup",function(e){e.keyCode===Stun.utils.codeToKeyCode("Enter")&&t()})}})}function closeSearch(){$("body").css({overflow:"auto"}),$(".search-popup").css({display:"none"}),$(".search-mask").css({display:"none"})}window.addEventListener("DOMContentLoaded",function(){Stun.utils.pjaxReloadLocalSearch=function(){$(".header-nav-search").on("click",function(e){e.stopPropagation(),$("body").css("overflow","hidden"),$(".search-popup").velocity("stop").velocity("transition.expandIn",{duration:300,complete:function(){$(".search-popup input").focus()}}),$(".search-mask").velocity("stop").velocity("transition.fadeIn",{duration:300}),initSearch()}),$(".search-mask, .search-close").on("click",function(){closeSearch()}),$(document).on("keydown",function(e){e.keyCode===Stun.utils.codeToKeyCode("Escape")&&closeSearch()})},Stun.utils.pjaxReloadLocalSearch()},!1)</script><script src="https://cdn.jsdelivr.net/npm/pjax@latest/pjax.min.js"></script><script>window.addEventListener("DOMContentLoaded",function(){new Pjax({selectors:["head title","#main",".pjax-reload"],history:!0,scrollTo:!1,scrollRestoration:!1,cacheBust:!1,debug:!1,currentUrlFullReload:!1,timeout:0});var e=null;document.addEventListener("pjax:send",function(){$(".header-nav-menu").removeClass("show"),CONFIG.pjax&&CONFIG.pjax.avoidBanner&&$("html").velocity("scroll",{duration:500,offset:$("#header").height(),easing:"easeInOutCubic"});var a=20;$(".loading-bar").addClass("loading"),$(".loading-bar__progress").css("width",a+"%"),clearInterval(e),e=setInterval(function(){95<(a+=3)&&(a=95),$(".loading-bar__progress").css("width",a+"%")},500)},!1),window.addEventListener("pjax:complete",function(){clearInterval(e),$(".loading-bar__progress").css("width","100%"),$(".loading-bar").removeClass("loading"),setTimeout(function(){$(".loading-bar__progress").css("width","0")},400),$("link[rel=prefetch], script[data-pjax-rm]").each(function(){$(this).remove()}),$("script[data-pjax], #pjax-reload script").each(function(){$(this).parent().append($(this).remove())}),Stun.utils.pjaxReloadBoot&&Stun.utils.pjaxReloadBoot(),Stun.utils.pjaxReloadScroll&&Stun.utils.pjaxReloadScroll(),Stun.utils.pjaxReloadSidebar&&Stun.utils.pjaxReloadSidebar()},!1)},!1)</script><div id="pjax-reload"><script src="https://cdn.jsdelivr.net/gh/sukkaw/busuanzi@latest/bsz.pure.mini.js" async></script></div><script src="https://cdn.jsdelivr.net/npm/leancloud-storage@latest/dist/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script><script data-pjax="">function loadValine(){var n=["nick","mail","link"],a="nick,mail,link";a=a.split(",").filter(function(a){return-1<n.indexOf(a)}),new Valine({el:"#valine-container",appId:"jopXGpKoDU5p4BsP7nFerKcN-MdYXbMMI",appKey:"Y9MzjOW5wP0rMrhvS4C2Wvay",notify:!1,verify:!0,placeholder:"不留点念想吗？",avatar:"mp",meta:a,pageSize:"10",visitor:!1,recordIP:!1,lang:"zh-cn",path:window.location.pathname})}loadValine()</script><script src="/js/utils.js?v=2.0.0-rc.0"></script><script src="/js/stun-boot.js?v=2.0.0-rc.0"></script><script src="/js/scroll.js?v=2.0.0-rc.0"></script><script src="/js/header.js?v=2.0.0-rc.0"></script><script src="/js/sidebar.js?v=2.0.0-rc.0"></script></body></html>